<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Avatar 3D Falante</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      #container {
        display: flex;
        width: 100%;
        height: 100%;
      }

      #canvas-container {
        flex: 1;
        position: relative;
      }

      #controls {
        width: 300px;
        background: rgba(255, 255, 255, 0.95);
        padding: 20px;
        box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      #text-input {
        width: 100%;
        height: 100px;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        resize: vertical;
        box-sizing: border-box;
      }

      #speak-btn {
        padding: 12px 20px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: transform 0.2s;
      }

      #speak-btn:hover {
        transform: translateY(-2px);
      }

      #speak-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      #status {
        padding: 10px;
        background: #f0f0f0;
        border-radius: 5px;
        font-size: 12px;
        text-align: center;
      }

      .speaking {
        background: #e8f5e8 !important;
        color: #2d5a2d;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="canvas-container"></div>
      <div id="controls">
        <h3>Digite sua mensagem:</h3>
        <textarea
          id="text-input"
          placeholder="Digite aqui o que vocÃª quer que o avatar fale..."
        ></textarea>
        <button id="speak-btn">ðŸŽ¤ Falar</button>
        <div id="status">Pronto para falar</div>
      </div>
    </div>

    <script>
      // VariÃ¡veis Three.js
      let scene, camera, renderer, avatar, head, mouth;
      let isAnimating = false;

      // Elementos DOM
      const textInput = document.getElementById("text-input");
      const speakBtn = document.getElementById("speak-btn");
      const status = document.getElementById("status");

      // Inicializar Three.js
      function init() {
        const container = document.getElementById("canvas-container");

        // Cena
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb);

        // CÃ¢mera
        camera = new THREE.PerspectiveCamera(
          75,
          container.offsetWidth / container.offsetHeight,
          0.1,
          1000,
        );
        camera.position.set(0, 1.6, 3);

        // Renderer
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.offsetWidth, container.offsetHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);

        // IluminaÃ§Ã£o
        const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(10, 10, 5);
        directionalLight.castShadow = true;
        scene.add(directionalLight);

        // Criar avatar
        createAvatar();

        // Controles de mouse simples
        let mouseX = 0;
        let mouseY = 0;

        container.addEventListener("mousemove", (event) => {
          mouseX = (event.clientX / container.offsetWidth) * 2 - 1;
          mouseY = -(event.clientY / container.offsetHeight) * 2 + 1;
        });

        // Loop de animaÃ§Ã£o
        animate();
      }

      function createAvatar() {
        avatar = new THREE.Group();

        // Corpo
        const bodyGeometry = new THREE.CylinderGeometry(0.4, 0.6, 1.5, 8);
        const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0x4a90e2 });
        const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
        body.position.y = 0.75;
        body.castShadow = true;
        avatar.add(body);

        // CabeÃ§a
        const headGeometry = new THREE.SphereGeometry(0.35, 16, 16);
        const headMaterial = new THREE.MeshLambertMaterial({ color: 0xffdbac });
        head = new THREE.Mesh(headGeometry, headMaterial);
        head.position.y = 1.8;
        head.castShadow = true;
        avatar.add(head);

        // Olhos
        const eyeGeometry = new THREE.SphereGeometry(0.05, 8, 8);
        const eyeMaterial = new THREE.MeshLambertMaterial({ color: 0x000000 });

        const leftEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
        leftEye.position.set(-0.12, 1.85, 0.3);
        avatar.add(leftEye);

        const rightEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
        rightEye.position.set(0.12, 1.85, 0.3);
        avatar.add(rightEye);

        // Boca
        const mouthGeometry = new THREE.SphereGeometry(0.08, 8, 8);
        const mouthMaterial = new THREE.MeshLambertMaterial({
          color: 0x8b0000,
        });
        mouth = new THREE.Mesh(mouthGeometry, mouthMaterial);
        mouth.position.set(0, 1.7, 0.32);
        mouth.scale.y = 0.3;
        avatar.add(mouth);

        // BraÃ§os
        const armGeometry = new THREE.CylinderGeometry(0.08, 0.12, 0.8, 8);
        const armMaterial = new THREE.MeshLambertMaterial({ color: 0xffdbac });

        const leftArm = new THREE.Mesh(armGeometry, armMaterial);
        leftArm.position.set(-0.5, 1.0, 0);
        leftArm.rotation.z = 0.3;
        leftArm.castShadow = true;
        avatar.add(leftArm);

        const rightArm = new THREE.Mesh(armGeometry, armMaterial);
        rightArm.position.set(0.5, 1.0, 0);
        rightArm.rotation.z = -0.3;
        rightArm.castShadow = true;
        avatar.add(rightArm);

        // Pernas
        const legGeometry = new THREE.CylinderGeometry(0.1, 0.15, 0.8, 8);
        const legMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 });

        const leftLeg = new THREE.Mesh(legGeometry, legMaterial);
        leftLeg.position.set(-0.2, -0.4, 0);
        leftLeg.castShadow = true;
        avatar.add(leftLeg);

        const rightLeg = new THREE.Mesh(legGeometry, legMaterial);
        rightLeg.position.set(0.2, -0.4, 0);
        rightLeg.castShadow = true;
        avatar.add(rightLeg);

        scene.add(avatar);

        // ChÃ£o
        const floorGeometry = new THREE.PlaneGeometry(10, 10);
        const floorMaterial = new THREE.MeshLambertMaterial({
          color: 0x90ee90,
        });
        const floor = new THREE.Mesh(floorGeometry, floorMaterial);
        floor.rotation.x = -Math.PI / 2;
        floor.position.y = -0.8;
        floor.receiveShadow = true;
        scene.add(floor);
      }

      function animate() {
        requestAnimationFrame(animate);

        // Movimento sutil da cabeÃ§a seguindo o mouse
        if (head && !isAnimating) {
          head.rotation.y = mouseX * 0.3;
          head.rotation.x = mouseY * 0.2;
        }

        renderer.render(scene, camera);
      }

      function speakAnimation(text) {
        if (isAnimating || !text.trim()) return;

        isAnimating = true;
        status.textContent = "Falando...";
        status.classList.add("speaking");
        speakBtn.disabled = true;

        // Usar Web Speech API se disponÃ­vel
        if ("speechSynthesis" in window) {
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = "pt-BR";
          utterance.rate = 0.9;

          utterance.onstart = () => {
            startMouthAnimation();
          };

          utterance.onend = () => {
            stopAnimation();
          };

          speechSynthesis.speak(utterance);
        } else {
          // Fallback: animaÃ§Ã£o sem Ã¡udio
          startMouthAnimation();
          setTimeout(stopAnimation, text.length * 100);
        }
      }

      function startMouthAnimation() {
        let animationCount = 0;
        const maxAnimations = 50; // Limite para evitar loop infinito

        function animateMouth() {
          if (!isAnimating || animationCount >= maxAnimations) return;

          animationCount++;

          // Animar boca
          const openAmount = Math.sin(Date.now() * 0.02) * 0.5 + 0.5;
          mouth.scale.y = 0.3 + openAmount * 0.7;
          mouth.scale.x = 1 + openAmount * 0.3;

          // Animar cabeÃ§a
          head.rotation.z = Math.sin(Date.now() * 0.005) * 0.1;
          head.position.y = 1.8 + Math.sin(Date.now() * 0.01) * 0.05;

          // Animar corpo levemente
          avatar.rotation.y = Math.sin(Date.now() * 0.003) * 0.05;

          setTimeout(animateMouth, 50);
        }

        animateMouth();
      }

      function stopAnimation() {
        isAnimating = false;
        status.textContent = "Pronto para falar";
        status.classList.remove("speaking");
        speakBtn.disabled = false;

        // Resetar posiÃ§Ãµes
        if (mouth) {
          mouth.scale.y = 0.3;
          mouth.scale.x = 1;
        }
        if (head) {
          head.rotation.z = 0;
          head.position.y = 1.8;
        }
        if (avatar) {
          avatar.rotation.y = 0;
        }
      }

      // Event listeners
      speakBtn.addEventListener("click", () => {
        const text = textInput.value;
        if (text.trim()) {
          speakAnimation(text);
        }
      });

      textInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && e.ctrlKey) {
          speakBtn.click();
        }
      });

      // Redimensionar
      window.addEventListener("resize", () => {
        const container = document.getElementById("canvas-container");
        camera.aspect = container.offsetWidth / container.offsetHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.offsetWidth, container.offsetHeight);
      });

      // Inicializar
      init();
    </script>
  </body>
</html>
